
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="CACHE-CONTROL" content="NO-CACHE">
  <!-- link rel="stylesheet" href="modal.css" -->
  <link rel="icon" type="image/png" href="fav.png">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.css" >
  <!-- script src= "https://unpkg.com/micromodal/dist/micromodal.min.js"></script -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bignumber.js/8.0.2/bignumber.min.js" integrity="sha512-7UzDjRNKHpQnkh1Wf1l6i/OPINS9P2DDzTwQNX79JxfbInCXGpgI1RPb3ZD+uTP3O5X7Ke4e0+cxt2TxV7n0qQ==" crossorigin="anonymous"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/easytimer@1.1.1/src/easytimer.min.js"></script>
   
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.css" />
  <script src="https://unpkg.com/@metamask/detect-provider/dist/detect-provider.min.js"></script>


  <title>블라인드 여론 조사 베팅 게임</title>
  <style>
    body {margin-left:50px; margin-top: 30px; margin-right:50px}
    #storedData {font-size:300%; margin-right:10px;}
    #newValue {width: 200px; margin-right:10px; text-align:right;}
	  pre {padding: 20px; box-sizing: border-box; max-height:300px; overflow-y: auto; margin-top: 0px;}
	  pre {white-space: pre-wrap; white-space: -moz-pre-wrap; white-space: -pre-wrap;  
         white-space: -o-pre-wrap; word-wrap: break-word;}
	  .comments {list-style-type: none;}

    ::placeholder { /* Chrome, Firefox, Opera, Safari 10.1+ */
      color: lightgray;
      opacity: 1; /* Firefox */
    }

    :-ms-input-placeholder { /* Internet Explorer 10-11 */
      color: lightgray;
    }

    ::-ms-input-placeholder { /* Microsoft Edge */
      color: lightgray;
    }    
  </style>
</head>
<body> 

  <h2>블라인드 여론 조사 베팅 게임</h2>
  <div id="msgAlert" style="display: none;">
  </div>
  <p>
    <button style="display:none;" id="btnConnect" onclick="connectAccount()">이더리움 연결하기</button>
  </p>
  <ul>
    <li>이더리움 네트워크: <span class="networkName"></span></li>
    <li>게임 컨트랙 주소: <span class="pollAddr"></span></li>
    <li>내 어카운트 주소: <span class="accountAddr"></span></li>
    <li>ETH 잔고: <span class="ethBalance"></span></li>
    <li>DKEY 토큰 잔고: <span class="tokenBalance"></span></li>
    <li>DKEY 토큰 허용액: <span class="tokenAllowed"></span>
      <a class="button button-outline" href="#modal-tokenAllow" rel="modal:open">허용액 설정하기</a>
    </li>
  </ul>
  <!-- modal-->  
  <div id="modal-tokenAllow" class="modal">
    <h4> DKEY 토큰 허용액 설정하기 </h4>
    <p> 게임에서 DKEY 토큰을 사용하기 위해서는 미리 허용액을 설정해야 합니다. 
        허용액을 설정하더라도 실제 토큰을 전송하는 것은 아니며, 게임 내에서 베팅시 바로 사용할 수 있도록 허용하는 것입니다.
    </p>
    <ul>
      <li style="width:350px;"><b>현재 DKEY 잔고:</b> <span class="tokenBalance" style="float:right;"></span></li>
      <li style="width:350px;"><b>현재 DKEY 허용:</b> <span class="tokenAllowed" style="float:right;"></span></li>
      <li><b> DKEY 허용액 설정:</b>
          <input type="text" id="newTokenAllowAmt" value="0", style="width:150px; text-align: right;">
          <button class="button" onclick="return setTokenAllow()">설정하기</button>
      </li>
    </ul>
    <div id="setTokenAllowTx"></div>
    <!-- a href="#" rel="modal:close">Close</a -->
  </div>
  <!--end modals-->
  <button onclick="toggleCreatePoll()">새 여론조사 만들기</button>  
  <div id="createPoll" style="display: none; width: 600px; background-color: #f7f7f7; padding: 20px;">
    <form id="formCreatePoll">
      <fieldset>
        <label for="pollMode">게임 방식</label>
        <select id="pollMode" onchange="checkChoiceCount()">
          <option value="0">High - 가장 많은 베팅액을 받은 선택지가 이김</option>
          <option value="1">Low - 가장 적은 베팅액을 받은 선택지가 이김</option>
          <option value="2">HighLow - 가장 많거나 가장 적은 베팅액을 받은 선택지가 이김 </option>
        </select>

        <label for="pollQuestion">질문</label>
        <textarea placeholder="조사하고 싶은 질문" id="pollQuestion"></textarea>

        <label >선택지</label>
        <input type="text" placeholder="답변" name="choice" class="pollChoice">
        <input type="text" placeholder="답변" name="choice" class="pollChoice">
        <button id="btnAddChoice" class="button button-outline" onclick="addChoice()">선택지 추가</button>
        <button id="btnRemoveChoice" class="button button-outline" onclick="removeChoice()">선택지 삭제</button>
        <p></p>
        <label for="startTime">시작 시간</label>
        <input type="radio" id="startTimeNow" name="startTime" value="0" checked>
        지금 시작
        <input type="radio" id="startTimeLater" name="startTime" value="1" style="margin-left: 20px;">
        <input type="text" id="startTimeLaterHours" value="1" style="width: 40px; text-align: right;">
        시간 후 시작 (최대 24시간) <br>

        <label for="startTime">오픈 기간</label>        
        <input type="text" id="durationHours" value="24" style="width: 60px; text-align: right;"> 시간 (최대 168 시간)
        <p></p>

        <button class="button button-outline" onclick="toggleCreatePoll()">취소 하기</button> 
        <button class="button button-outline" onclick="resetCreatePoll()">새로 고치기</button> 
        <button id="btnInsertChoice" class="button" onclick="sendPoll()">등록 하기</button>  
        <div id="createPollTx"></div>             
      </fieldset>
    </form>
  </div>
  <script>

    $("#formCreatePoll").submit(function(e){
        return false;
    });  

    function showMsg(msg, hideClose) {
      $("#msgAlert").html(msg);
      if (hideClose) {
        $("#msgAlert").modal({escapeClose: false, clickClose: false, showClose: false});    
      } else {
        $("#msgAlert").modal();  
      }
      
    }

    function toggleCreatePoll() {
      $("#createPoll").toggle();
      
    }
    function addChoice() {
      if($("input[name='choice']").length == 10) {
        alert("선택지는 최대 10개까지 허용됩니다.");
        return;
      }
      $('<input type="text" placeholder="답변" name="choice" class="addedChoice pollChoice">').insertBefore("#btnAddChoice");
    }

    function removeChoice() {
      if ($("#pollMode").val() == 2 && $(".pollChoice").length == 3) {
          alert("HigLow 게임모드에서는 최소한 3개의 선택지가 있어야 합니다.");
      } else {
        $(".addedChoice").last().remove();
      }
    }

    function resetCreatePoll() {
      $("#formCreatPoll").trigger('reset')    
      $(".addedChoice").remove();
    }

    function checkChoiceCount() {
      if ($("#pollMode").val() == 2){
        if ($(".pollChoice").length < 3) {
          addChoice();
        }
      }
    }

    async function sendPoll() {
      var question = $("#pollQuestion").val();
      var mode = $("#pollMode").val();
      var choices = [];
      var start = 0;
      var startTimeLaterHours = $("#startTimeLaterHours").val();
      var durationHours = $("#durationHours").val();
      var duration = durationHours*60*60;

      
      $("input[name='choice']").each(function(index) {
        var val = $(this).val();
        if (val) choices.push($(this).val());
      })
      if ($("input[name='startTime']:checked").val() == "1") {
        start = startTimeLaterHours*60*60;
      }
      var errorMsg = "";
      if (!question) errorMsg += "<li>질문내용이 없습니다.</li>";
      if (mode=="2" && choices.length < 3) {errorMsg += "<li>HighLow 게임모드에서는 최소한 3개 이상의 선택지 내용이 필요합니다.</li>";}
      else if (choices.length < 2) {errorMsg += "<li>최소한 2개 이상의 선택지 내용이 필요합니다.</li>";}
      if (startTimeLaterHours > 24) {errorMsg += "<li>시작 시간은 24시간 이내로만 설정할 수 있습니다.</li>";}
      if (durationHours > 168) {errorMsg += "<li>오픈 기간은 최대 168시간까지만 가능합니다.</li>";}
      if (errorMsg) {
        showMsg("<h5>새 여론조사 작성오류:</h5>" + errorMsg);
        return false;
      }
      var gas = await pollContract.methods.createPoll(start, duration, question, choices, mode).estimateGas({from: myAddr});
      pollContract.methods.createPoll(start, duration, question, choices, mode).send({from: myAddr, gas: gas})
      .on('transactionHash', (txid) => {
        $("#createPollTx").html(`트랜잭션 정보 txid: ${getLink(txid)} <span id="pending-pollTx" style="color:red;"><img src="spin.gif">블록체인 컨펌 대기중...</span>`);    
      })
      .once('receipt', (receipt) => {
        $('#pending-pollTx').html('<br>(기록된 블록: ' + receipt.blockNumber + ')');
        $('#pending-pollTx').css('color', 'green');
        updateAllbalances();        
      })
      .on('error', (error) => {
        $('#pending-pollTx').html('(트랜잭션 실행 실패)');
        $('#pending-pollTx').css('color', 'red');
      })
    }
  </script>
  <p></p>
  <h3 class="title">진행중인 조사</h3>

  <div id="activePolls">
  </div>

  <div id="comingPolls">
  </div>

  <div id="finishedPolls">
  </div>

  
  <p>by Atomrigs © 2020 </p>


  <script src="https://cdn.jsdelivr.net/npm/web3@1.2.11/dist/web3.min.js"></script>
  <!-- script src="https://unpkg.com/@metamask/detect-provider/dist/detect-provider.min.js"></script -->
  <script src="https://cdn.ethers.io/lib/ethers-5.0.umd.min.js"></script>
  
  <script>
    var BN = BigNumber;
    var pollAbi = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"pollId","type":"uint256"},{"indexed":true,"internalType":"address","name":"bettor","type":"address"},{"indexed":false,"internalType":"uint256","name":"index","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint32","name":"totalBetCount","type":"uint32"},{"indexed":false,"internalType":"uint32","name":"totalBetAmount","type":"uint32"}],"name":"BetCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"pollId","type":"uint256"},{"indexed":true,"internalType":"address","name":"creator","type":"address"},{"indexed":false,"internalType":"uint32","name":"startTime","type":"uint32"},{"indexed":false,"internalType":"uint32","name":"duration","type":"uint32"},{"indexed":false,"internalType":"uint8","name":"mode","type":"uint8"}],"name":"PollCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"pollId","type":"uint256"},{"indexed":true,"internalType":"address","name":"bettor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint8","name":"payType","type":"uint8"}],"name":"PollPaid","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"pollId","type":"uint256"}],"name":"PollRevealed","type":"event"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"bets","outputs":[{"internalType":"uint8","name":"choiceDecoded","type":"uint8"},{"internalType":"address","name":"bettor","type":"address"},{"internalType":"uint32","name":"betAmount","type":"uint32"},{"internalType":"uint32","name":"paidAmount","type":"uint32"},{"internalType":"bytes32","name":"choiceHash","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint32","name":"_startTime","type":"uint32"},{"internalType":"uint32","name":"_duration","type":"uint32"},{"internalType":"string","name":"_question","type":"string"},{"internalType":"string[]","name":"_choices","type":"string[]"},{"internalType":"uint8","name":"_mode","type":"uint8"}],"name":"createPoll","outputs":[{"internalType":"uint256","name":"pollId","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"deployedBlock","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"gameInfo","outputs":[{"internalType":"uint16","name":"totalPollCount","type":"uint16"},{"internalType":"uint32","name":"totalBetCount","type":"uint32"},{"internalType":"uint32","name":"totalBetAmount","type":"uint32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"gameRule","outputs":[{"internalType":"uint8","name":"operatorCommission","type":"uint8"},{"internalType":"uint8","name":"creatorCommission","type":"uint8"},{"internalType":"uint8","name":"maxChoiceCount","type":"uint8"},{"internalType":"uint16","name":"maxBetCount","type":"uint16"},{"internalType":"uint32","name":"minBetAmount","type":"uint32"},{"internalType":"uint32","name":"maxBetAmount","type":"uint32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint8","name":"_choice","type":"uint8"},{"internalType":"address","name":"_addr","type":"address"},{"internalType":"bytes32","name":"_secreteSalt","type":"bytes32"}],"name":"getHash","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"pure","type":"function"},{"inputs":[{"internalType":"uint256","name":"_pollId","type":"uint256"}],"name":"getPollChoices","outputs":[{"internalType":"string[]","name":"","type":"string[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getPollCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_pollId","type":"uint256"}],"name":"getStatus","outputs":[{"internalType":"enum BlindPollBet.Status","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_pollId","type":"uint256"}],"name":"isActive","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_pollId","type":"uint256"}],"name":"isFinished","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_pollId","type":"uint256"}],"name":"isPaid","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_pollId","type":"uint256"},{"internalType":"bytes32","name":"_secreteSalt","type":"bytes32"}],"name":"payPoll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_pollId","type":"uint256"},{"internalType":"bytes32","name":"_choiceHash","type":"bytes32"},{"internalType":"uint32","name":"_betAmount","type":"uint32"}],"name":"pollBet","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"pollChoices","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"pollDetails","outputs":[{"internalType":"bool","name":"isPaid","type":"bool"},{"internalType":"bool","name":"isTerminated","type":"bool"},{"internalType":"uint16","name":"betCount","type":"uint16"},{"internalType":"uint32","name":"totalAmount","type":"uint32"},{"internalType":"bytes32","name":"secretSalt","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint8","name":"","type":"uint8"}],"name":"pollResults","outputs":[{"internalType":"uint32","name":"","type":"uint32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"polls","outputs":[{"internalType":"uint8","name":"choiceCount","type":"uint8"},{"internalType":"uint8","name":"mode","type":"uint8"},{"internalType":"address","name":"creator","type":"address"},{"internalType":"uint32","name":"startTime","type":"uint32"},{"internalType":"uint32","name":"duration","type":"uint32"},{"internalType":"string","name":"question","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint32","name":"_val","type":"uint32"}],"name":"setMaxBetAmount","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint16","name":"_val","type":"uint16"}],"name":"setMaxBetCount","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint32","name":"_val","type":"uint32"}],"name":"setMinBetAmount","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bool","name":"_val","type":"bool"}],"name":"setNewPollAllow","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_pollId","type":"uint256"}],"name":"terminatePoll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"tokenAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_tokenAddr","type":"address"}],"name":"updateToken","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint8","name":"","type":"uint8"}],"name":"winningChoices","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_toAddr","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"withdrawTo","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];
    var tokenAbi = [{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"constant":true,"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"subtractedValue","type":"uint256"}],"name":"decreaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"addedValue","type":"uint256"}],"name":"increaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"}];
    var pollAddr;
    var tokenAddr;
    var pollContract;
    var tokenContract;
    var tokenAllowed;
    var myAddr;
    var chainId = 42; //Goerli testnet
    var decDigits = 18; //token decimal digit
    var networkList = {
      1: "메인넷",
      3: "Ropsten 테스트넷",
      4: "Rinkeby 테스트넷",
      5: "Goerli 테스트넷",
      42: "Kovan 테스트넷",
      1337: "Gnache 로컬넷"
    };
    var pollHashes = [];

    window.addEventListener("load", function() {

      if (typeof window.ethereum !== "undefined") {
        window.web3 = new Web3(window.ethereum);
      } else if (typeof web3 !== "undefined") {
        window.web3 = new Web3(web3.currentProvider);
      } else {
        window.web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
      }
      if (typeof window.web3 !== "undefined") {
        startApp();
      } else {
        alert("You need to install dapp browser first to use this site!")
      }
    });

    async function startApp() {
      try {
        var currentChainId = parseInt(await ethereum.request({method: "eth_chainId"}));
        $(".networkName").html(networkList[currentChainId]);
        if (currentChainId != chainId) {
          var wrongChainMsg = "이 게임은 오직 " + networkList[chainId] + "에서만 작동합니다.<br> Dapp 브라우저의 네트워크를 바꾸어 주세요.";
          showMsg(wrongChainMsg, true);
          watchChainAccount();
          return
        }
        getAccount();
      } catch(err) {console.log(err);}
    }

    function toFixed(weiVal, digit=4) {
      return BN(weiVal).div(BN(10**decDigits)).toFormat(digit);
    }

    async function getAccount() {
      try {
        var accounts = await ethereum.request({method: "eth_accounts"});
        if (accounts.length > 0) {
          myAddr = web3.utils.toChecksumAddress(accounts[0]);
          $(".accountAddr").html(getLink(myAddr));
          getContracts();
        } else {
          getElem("btnConnect").style.display = "block";   
          console.log("No ethereum account is available!")
        }
        web3.currentProvider.on("accountsChanged", (accounts) => {
          startApp();
          console.log(accounts);
        });

        web3.currentProvider.on("chainChanged", (chainId) => {
          startApp();
        });

      } catch(err) {
        console.log(err);}
    }

    async function getContracts() {
      try {
        if (chainId==1) {
          pollAddr = ""; 
          tokenAddr = "";
        }
        else if (chainId==5) { 
          pollAddr = "0x39C78E57562ad1D999758aFe6Bb16590bE8D578B";
          tokenAddr = "0x155d2A49BB97e6b2aFbD50Bba93191eC9DdE5613";
        }
        else if (chainId==42) { 
          pollAddr = "0xd6e60E0FBBE52a3C4317cD118dc0Ca8cEfCeA5BC"; //test
          //pollAddr = "0x0b9f85A3a6700a25290FDBc0F1d048d7Ac1DA3D8"; 
          tokenAddr = "0x9dBd912c7b31E70ADc1E9808f4C818B275945423";
        }

        else {
          console.log("not supported chain " + chainId);
          return;
        }

        pollContract = new web3.eth.Contract(pollAbi, pollAddr);
        tokenContract = new web3.eth.Contract(tokenAbi, tokenAddr);

        $(".pollAddr").html(getLink(pollAddr));
        await updateAllbalances();
        await getPolls();
        await getNewBets();
        watchChainAccount();
      } catch(err) {console.log(err);}
    }

    function watchChainAccount() {
      web3.currentProvider.on("accountsChanged", (accounts) => {
        startApp();
        showMsg("<p>어카운트가 변경되었습니다!</p><button onclick='location.reload()'>다시 로딩하기</button>");
      });
      web3.currentProvider.on("chainChanged", (chainId) => {
        startApp();
        showMsg("<p>네트워크(체인)가 변경되었습니다!</p><button onclick='location.reload()'>다시 로딩하기</button>");
      });
    }



    function connectAccount() {
      ethereum
        .request({method: "eth_requestAccounts"})
        .then((accounts) => {
          myAddr = accounts[0];
          $("#accountAddr").html(getLink(myAddr));
          $("#btnConnect").css("display", "none");
          startApp();
        })
        .catch((err) => {
          if (err.code === 4001) {
            // EIP-1193 userRejectedRequest error
            // If this happens, the user rejected the connection request.
            console.log("Please connect to Your wallet!");
          } else {
            console.error(err);
          }
        });
    }

    async function setTokenAllow() {
      var value = BN($("#newTokenAllowAmt").val()).multipliedBy(BN(10**decDigits)).toString(10);
      var gas = await tokenContract.methods.approve(pollAddr, value).estimateGas({from: myAddr});
      tokenContract.methods.approve(pollAddr, value).send({from: myAddr, gas: gas})
      .on("transactionHash", (txid) => {
        $("#setTokenAllowTx").html('트랜잭션 정보 txid: ' + getLink(txid) + '<span id="pending" style="color:red;"><img src="spin.gif">블록체인 컨펌 대기중...</span>');    
      })
      .once("receipt", (receipt) => {
        $("#pending").html("<br>(기록된 블록: " + receipt.blockNumber + ")");
        $("#pending").css("color", "green");
        $("#newTokenAllowAmt").val(0);
        updateAllbalances();        
      })
      .on('error', (error) => {
        $('#pending').html('(트랜잭션 실행 실패!)');
        $('#pending').css('color', 'red');
      })
    }

    /* helper function */
    function getElem(elemId) {
      return document.getElementById(elemId);
    }

    function getLink(addr) {
      if (chainId == 1) {explorer = "https://etherscan.io";}
      else if(chainId == 3) {explorer = "https://ropsten.etherscan.io";}
      else if(chainId == 4) {explorer = "https://rinkeby.etherscan.io";}
      else if(chainId == 5) {explorer = "https://goerli.etherscan.io";}
      else if (chainId == 42) {explorer = "https://kovan.etherscan.io";}
      else {
        explorer = "";
        console.log("unsupported chainid " + chainId);
      }
      var shortAddr = addr.substring(0, 6) + "...." + addr.substring(addr.length -4);        

      if (addr.length == 42) {
        return '<a target="_blank" style="text-decoration: underline;" href="' + explorer + '/address/' + addr + '">' + shortAddr +'</a>';
      } else {
        return '<a target="_blank" style="text-decoration: underline;" href="' + explorer + '/tx/' + addr + '">' + shortAddr +'</a>'; 
      }
    }

    function convertTimestamp(unix_timestamp) {
      return (new Date(unix_timestamp*1000)).toLocaleString();
    }

    async function updateAllbalances() {
      var weiEthBal = await web3.eth.getBalance(myAddr);
      $(".ethBalance").html(toFixed(weiEthBal) + ' ETH').valAnimate();
      var rawTokenAmt = await tokenContract.methods.balanceOf(myAddr).call();
      $(".tokenBalance").html(toFixed(rawTokenAmt, 2) + ' DKEY').valAnimate();        
      var rawtokenAllowed = await tokenContract.methods.allowance(myAddr, pollAddr).call();
      tokenAllowed = toFixed(rawtokenAllowed, 2)
      $(".tokenAllowed").html(tokenAllowed + ' DKEY').valAnimate();
      tokenAllowed = tokenAllowed.replace(',', '')                
    }

    async function getPolls() {
      var startingBlock = await pollContract.methods.deployedBlock().call();
      pollContract.events.PollCreated({fromBlock: startingBlock})
      .on("data", async function(r) { 
        
        let active = await pollParser(r) 
        if (active) {
          activateTimer('timer-'+active.pollId, active.timeLeft, endPoll);        
        }
        
      })
      .on("error", function(error, receipt){console.log(error);});
    }

    async function pollParser(r){
      if (pollHashes.includes(r.transactionHash)) { return }
      pollHashes.push(r.transactionHash);

      var now = parseInt(Date.now()/1000);
      var start = parseInt(r.returnValues.startTime);
      var end = start + parseInt(r.returnValues.duration);
      var pollId = r.returnValues.pollId;
      var timeLeft = end - now;
      if (start <= now && end > now) { //active polls accepting new bets
        var poll = await pollContract.methods.polls(pollId).call();
        if (!poll.isTerminated) {
          var pollDetail = await pollContract.methods.pollDetails(pollId).call();
          var pollChoices = await pollContract.methods.getPollChoices(pollId).call();
          var pollDiv = makePoll(pollId, poll, pollDetail, pollChoices);
          $("#activePolls").prepend(pollDiv);
          return { pollId, timeLeft };
        }
      } else if (end <= now) { //finishied polls
        
        $("finishedPolls").prepend($("p").html(r.startTime));
      } else { //comming pools
        $("comingPolls").prepend($("p").html(r.startTime));
      }
    }


    function makePoll(pollId, poll, pollDetail, pollChoices) {
      var pollD = $(`<div id="poll-${pollId}" class="poll"></div>`);
      var headDiv = $(`<div class="pollHead"></div>`);
      var choicesDiv = $(`<div class="pollChoices"></div>`);
      var betDiv = $(`<div class="pollBet"></div>`);

      headDiv.append($(`<div class="question">${poll.question}</div>`));
      var pollMode;
      if (poll.mode == 0) { pollMode = "High"; }
      else if (poll.mode == 1) { pollMode = "Low"; }
      else { pollMode = "HighLow"; }
      var endTime = parseInt(poll.startTime) + parseInt(poll.duration);
      headDiv.append($(`<span class="pollId"><span class="pollKey">PollID: </span><span>${pollId}</span></span>`));
      headDiv.append($(`<span class="pollMode"><span class="pollKey">게임모드: </span><span>${pollMode}</span></span>`));
      headDiv.append($(`<span class="pollEndTime"><span class="pollKey">종료시간: </span><span>${convertTimestamp(endTime)}</span></span>`));
      headDiv.append($(`<span class="pollTimeLeft"><span class="pollKey">남은시간: </span><span id="timer-${pollId}"></span></span>`));
      headDiv.append($(`<span class="pollBetCount"><span class="pollKey">베팅수: </span><span id="pollBetCount-${pollId}">${pollDetail.betCount}</span></span>`));
      headDiv.append($(`<span class="pollBetAmount"><span class="pollKey">총베팅액: </span><span id="pollBetAmount-${pollId}">${pollDetail.totalAmount}</span></span>`));
      pollD.append(headDiv);
      let choicesHtml = `<ul style="list-style: none;">`;
      for (let i=0; i < pollChoices.length; i++) {
        choicesHtml += `<li><input type="radio" name="choices-${pollId}" value="${i+1}"> ${i+1}. ${pollChoices[i]}</li>`;
      }
      choicesHtml += "</ul>";
      choicesDiv.append(choicesHtml);
      pollD.append(choicesDiv);

      betDiv.append($(`<span>베팅 dKey 토큰수</span> <input type="text" id="betAmount-${pollId}" placeholder="0" style="width:150px; text-align: right;"> \
                       <button class="button" onclick="pollBet('${pollId}')" >베팅하기</button>`));
      betDiv.append($(`<div id="txResult-${pollId}"></div>`));

      pollD.append(betDiv);
      return pollD;
    }

    async function pollBet(pollId){
      const betAmount = parseInt($(`#betAmount-${pollId}`).val())
      const choice = $(`input[name='choices-${pollId}']:checked`).val()

      var errorMsg = "";
      if (betAmount < 1) errorMsg += "<li>최소 베팅금액은 1 DKEY 입니다. </li>";
      if (betAmount > 10000) errorMsg += "<li>1회 최대 베팅금액은 10000 DKEY 입니다. </li>";
      if (betAmount > parseInt(tokenAllowed)) { errorMsg += "<li>사용할 수 있도록 허용된 DKEY 수가 부족합니다. 허용액을 늘려주세요.</li>"}
      if (!choice) errorMsg += "<li>답변 중 하나를 선택해야 됩니다. </li>";
      if (errorMsg) {
        showMsg("<h5>베팅 오류:</h5>" + errorMsg);
        return false;
      }

      const choiceHash = await getChoiceHash(pollAddr, pollId, myAddr, choice) 
      var gas = await pollContract.methods.pollBet(pollId, choiceHash, betAmount).estimateGas({from: myAddr});

      pollContract.methods.pollBet(pollId, choiceHash, betAmount).send({from: myAddr, gas: gas})
      .on('transactionHash', (txid) => {
        $(`#txResult-${pollId}`).html(`트랜잭션 정보 txid: ${getLink(txid)} <span id="pending-${pollId}" style="color:red;"><img src="spin.gif">블록체인 컨펌 대기중...</span>`);    
      })
      .once('receipt', (receipt) => {
        $(`#pending-${pollId}`).html(`<br>(기록된 블록: ${receipt.blockNumber})`);
        $(`#pending-${pollId}`).css('color', 'green');
        updateAllbalances();        
      })
      .on('error', (error) => {
        $(`#pending-${pollId}`).html(`<br>(트랜잭션 실행 실패)`);
        $(`#pending-${pollId}`).css('color', 'red');
      })
    }

    function activateTimer(targetId, secs, callback) {
      let timer = new Timer();
      let target = $(`#${targetId}`);
      timer.start({countdown: true, startValues: {seconds: secs}});
      target.html(timer.getTimeValues().toString());
      timer.addEventListener('secondsUpdated', function (e) {
        target.html(timer.getTimeValues().toString());
      });
      timer.addEventListener('targetAchieved', function (e) {
        target.html('종료');
        if (callback) {
          callback(target);
        }
      });
    }
    function endPoll(poll) {
      //remove bet feature
    }
    
    async function apiPost(host, resource, data, accessToken) {
      const headers = { 'Content-Type': 'application/json',
                      'Accept': 'application/json' 
                      }
      if (accessToken) {
        headers['Authorization'] = 'Bearer ' + accessToken
      }
      const url = host + resource;
      return await fetch(url, { method: 'post', headers: headers, 
        body: JSON.stringify(data) })
    }

    async function getChoiceHash(contract, pollId, address, choice) {
      //const api = 'https://blindpoll.atomrigs.io/api/v1/'
      const api = 'http://localhost:3000/api/v1/'
      const resource = 'getHash'
      data = { contract, pollId, address, choice}
      res = await apiPost(api, resource, data)
      json = await res.json()
      if (res.status == 200) {
        return json.hash
      } else {
        return json.err
      }
    }

    async function getNewBets() {
      const currentBlock = await web3.eth.getBlockNumber();
      pollContract.events.BetCreated({fromBlock: currentBlock})
      .on("data", async function(r) { 
        const pollId = r.returnValues.pollId;
        const pollBetCount = parseInt(r.returnValues.index) + 1;
        const pollBetAmount = parseInt($(`#pollBetAmount-${pollId}`).html()) + parseInt(r.returnValues.amount);
        $(`#pollBetCount-${pollId}`).html(pollBetCount).valAnimate();
        $(`#pollBetAmount-${pollId}`).html(pollBetAmount).valAnimate();
      })
      .on("error", function(error, receipt){console.log(error);});
    }

    jQuery.fn.valAnimate = function() {
      this.fadeOut().fadeIn('slow');
    }

  </script>
</body>
</html>

